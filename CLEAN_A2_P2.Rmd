---
title: "CLEAN_A2_P2"
author: "Study group 4"
date: "21/9/2020"
output: html_document
---
#Loading data and packages
```{r}
pacman::p_load(readr,dplyr,stringr,lmerTest,Metrics,caret)


```



### Exercise 1) Testing model performance

- recreate the models you chose last time (just write the model code again and apply it to your training data (from the first assignment))

```{r}

# Load training Data
train_df <- read_csv("~/Uni stuff/Expmeth3/methods3_A2_p2/data_clean.csv")

max <-  lmer(CHI_MLU ~ I(Visit^2)+Visit*Diagnosis+ Socialization*Diagnosis + verbalIQ1+(1|Child.ID), train_df, REML = F)

```

- create the test dataset (apply the code from assignment 1 to clean up the 3 test datasets)

```{r}
CleanUpData <- function(Demo,LU,Word){
  
  Speech <- merge(LU, Word) %>% 
    rename(
      Child.ID = SUBJ, 
      Visit=VISIT) %>%
    mutate(
      Visit = as.numeric(str_extract(Visit, "\\d")),
      Child.ID = gsub("\\.","", Child.ID)
      ) %>%
    dplyr::select(
      Child.ID, Visit, MOT_MLU, CHI_MLU, types_MOT, types_CHI, tokens_MOT, tokens_CHI
    )
  
  Demo <- Demo %>%
    dplyr::select(
      Child.ID, Visit, Ethnicity, Diagnosis, Gender, Age, ADOS, MullenRaw, ExpressiveLangRaw, Socialization
    ) %>%
    mutate(
      Child.ID = gsub("\\.","", Child.ID)
    )
    
  Data=merge(Demo,Speech,all=T)
  
  Data1= Data %>% 
     subset(Visit=="1") %>% 
     dplyr::select(Child.ID, ADOS, ExpressiveLangRaw, MullenRaw, Socialization) %>%
     rename(Ados1 = ADOS, 
            verbalIQ1 = ExpressiveLangRaw, 
            nonverbalIQ1 = MullenRaw,
            Socialization1 = Socialization) 
  
  Data=merge(Data, Data1, all=T) %>%
    mutate(
      Child.ID = as.numeric(as.factor(as.character(Child.ID))),
      Visit = as.numeric(as.character(Visit)),
      Gender = recode(Gender, 
         "1" = "M",
         "2" = "F"),
      Diagnosis = recode(Diagnosis,
         "A"  = "ASD",
         "B"  = "TD")
    )

  return(Data)
}


#- create the test dataset (apply the code from assignment 1 or my function to clean up the 3 test datasets)
# Test data
Demo <- read_csv("~/Uni stuff/Expmeth3/methods3_A2_p2/demo_test.csv")
LU <- read_csv("~/Uni stuff/Expmeth3/methods3_A2_p2/LU_test.csv")
token <- read_csv("~/Uni stuff/Expmeth3/methods3_A2_p2/token_test.csv")

df_test <- CleanUpData(Demo, LU, token)
```

- calculate performance of the model on the training data: root mean square error is a good measure. (Tip: google the function rmse())

```{r}
train_df <- train_df[!is.na(train_df$CHI_MLU), 1:20] 

rmse(train_df$CHI_MLU, fitted(max))
#0.45


mean(train_df$CHI_MLU)
#1.99
```


- test the performance of the models on the test data 
```{r}

#This shows the predicted MLU
predict_chi <- predict(max, newdata = df_test, allow.new.levels = TRUE)

predict_chi

df_test <- df_test[!is.na(df_test$CHI_MLU), 1:20] 

#the fit of the predicted 
rmse(df_test$CHI_MLU, predict_chi)


mean(df_test$CHI_MLU)
#This doesn't seem like a good performance at all! :(

```

### Exercise 2) Model Selection via Cross-validation (N.B: ChildMLU!)

- Use cross-validation to compare your model from last week with the basic model (Child MLU as a function of Time and Diagnosis, and don't forget the random effects!)

```{r}

```

- Now try to find the best possible predictive model of ChildMLU, that is, the one that produces the best cross-validated results.

```{r}

```


### Exercise 3) Assessing the single child

- how does the child fare in ChildMLU compared to the average TD child at each visit? Define the distance in terms of absolute difference between this Child and the average TD.

```{r}
#Finding BERNIE
Bernie <- subset(df_test, Child.ID == 4)
mean(Bernie$CHI_MLU)
Bernie$CHI_MLU

#Subsetting for TD
test_TD <- subset(df_test, Diagnosis == "TD")

#average for TD child at each visit

pacman::p_load(data.table)

meanMLUTD <- aggregate(test_TD[, 12], list(test_TD$Visit), mean)

meanMLUTD <- rename(meanMLUTD, "Visit" = "Group.1")
meanMLUTD <- rename(meanMLUTD, "mean_MLU_TD" = "CHI_MLU")

#Inserting the mean in Bernies dataset
Bernie <- merge(Bernie, meanMLUTD, by = "Visit")

#Calculating the absolute difference
Bernie$AD_TD <- (Bernie$CHI_MLU - Bernie$mean_MLU_TD )

mean(Bernie$AD_TD)

#Subsetting for ASD
test_ASD <- subset(df_test, Diagnosis == "ASD")

#average for TD child at each visit

meanMLUASD <- aggregate(test_ASD[, 12], list(test_ASD$Visit), mean)

meanMLUASD <- rename(meanMLUASD, c("Visit" = "Group.1", "mean_MLU_ASD" = "x"))

#Inserting the mean in Bernies dataset
Bernie <- merge(Bernie, meanMLUASD, by = "Visit")

#Calculating the absolute difference
Bernie$AD_ASD <- (Bernie$CHI_MLU - Bernie$mean_MLU_ASD )

mean(Bernie$AD_ASD)

#Plotting Bernie against means for TD and ASD (geom_smooth er ikke nødvendigvis det pæneste men synes det giver mening at se at Bernie er nogenlunde paralel med TD i udvikling. Måske fjerne SE)
ggplot(Bernie) +
  geom_point(aes(y=mean_MLU_TD , x=Visit, color = "red" , )) +
  geom_smooth(aes(y=mean_MLU_TD, x=Visit, color = "red"), method = lm , alpha = 0) +
  geom_point(aes(y=mean_MLU_ASD , x=Visit, color = "blue")) + 
  geom_smooth(aes(y=mean_MLU_ASD, x=Visit, color = "blue"), method = lm, alpha = 0) +
  geom_point(aes(y=CHI_MLU, x=Visit, color = "green")) +
  geom_smooth(aes(y=CHI_MLU, x=Visit, color = "green"), method = lm, alpha = 0) +
  scale_color_discrete(name="Diagnosis",
                         breaks=c("red", "green", "blue"),
                         labels=c("mean TD", "Bernie", "mean ASD")) +
  ylab("MLU")
```



- how does the child fare compared to the model predictions at Visit 6? Is the child below or above expectations? (tip: use the predict() function on Bernie's data only and compare the prediction with the actual performance of the child) #See below
```{r}

Bernie$predict_max <- predict(bmaxv, newdata = Bernie, allow.new.levels = TRUE)


Bernie$dif_max <- (Bernie$predict_max - Bernie$CHI_MLU) 

Bernie$dif_max 

rmse(Bernie$CHI_MLU, predict_bmax) #0.85

ggplot(Bernie)+
  geom_point(aes(y = predict_max , x = Visit, color = "red")) +
  geom_point(aes(y = CHI_MLU, x = Visit, color = "blue")) +
  scale_color_discrete(name=" ",
                         breaks=c("red", "blue"),
                         labels=c("Predicted", "Bernie MLU")) +
  ylab("MLU")
```

